---
title: Отчет за неделю от TJournal
output: 
  html_document: 
    df_print: kable
---

```{r set-options, include = FALSE}
Sys.setlocale("LC_CTYPE", "russian")
```

```{r, results='asis', include = FALSE}
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(kableExtra)


```


```{r, include = FALSE}
tj_api <- function(path){
    url <- modify_url("https://api.tjournal.ru/", path = path)
    resp <- GET(url)
    parsed <- jsonlite::fromJSON(content(resp, "text"), simplifyVector = FALSE)
    
    structure(
        list(
            content = parsed,
            path = path,
            response = resp
        ),
        class = "TJ_api"
    )
}


print.tj_api <- function(x, ...) {
    cat("<tj_api ", x$path, ">\n", sep = "")
    str(x$content)
    invisible(x)
}
```

```{r, echo = F}
get_popular <- function(period = "week"){
    url <- paste0("v1.8/timeline/mainpage/", period)
    mainpage <- tj_api(url)
    titles <- sapply(mainpage$content$result, function(x){x$title})
    hits <- sapply(mainpage$content$result, function(x){x$hitsCount})
    link <- sapply(mainpage$content$result, function(x){x$url})
    link_md <- paste("[link]","(",link,")",sep="")
    img <- sapply(mainpage$content$result, function(x){x$cover$url})
    img_type <- sapply(mainpage$content$result, function(x){x$cover$additionalData$type})
    img_md <- c()
    for(i in 1:length(img)){
      if(img[i] != "NULL"){
        if(img_type[i] == "jpg" | img_type[i] == "png"){
          img_md[i] <- paste("!","[image]","(", img[i], ")", sep = "")
        } else {
          img_md[i] <- ""
        }
      } else{
         img_md[i] <- ""
      }
    }
    pub_date <- sapply(mainpage$content$result, function(x){x$date})
    brief <- sapply(mainpage$content$result, function(x){x$summarize})
    id <- seq()
    together <- tibble(title = titles,
                       summary = brief,
                       hits = hits, 
                       image = img_md,
                       date = date(as_datetime(pub_date)), 
                       link = link_md) %>%
      arrange(desc(hits)) %>%
      mutate(id = seq_along(title), prop = round(cumsum(hits)/sum(hits),2)) %>%
      relocate(id)
    return(together)
}
together <- get_popular()
```


### От `r day(min(together$date))` до `r day(max(together$date))`, `r month(max(together$date),label = TRUE, locale = Sys.setlocale("LC_CTYPE", "russian"))`
Всего: `r nrow(together)` новостей в списке
```{r, echo = F}
kable(together, col.names = c("Номер",
                              "Заголовок",
                              "Краткое содержание",
                              "Просмотры",
                              "Картинка",
                              "Дата",
                              "Ссылка",
                              "Доля"),) %>%
  kable_styling(bootstrap_options = c("striped"), fixed_thead = T)

plot(together$id, together$hits)
plot(together$prop)
abline(h = 0.8)
```






